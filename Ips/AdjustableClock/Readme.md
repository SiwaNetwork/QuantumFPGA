# Описание дизайна Adjustable Clock
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Набор регистров](#3-register-set)

[4. Описание дизайна](#4-design-description)

## 1. Обзор
Adjustable Clock — это таймер‑часы в формате «Секунды/Наносекунды» с возможностью регулировки частоты и фазы.
При каждом такте он добавляет к счётчику наносекунд период системной тактовой в наносекундах. При переполнении счётчика наносекунд (1_000_000_000) увеличивается счётчик секунд.
Для корректировок могут добавляться/вычитаться дополнительные наносекунды из стандартного периода для регулировки частоты и фазы. Если малые смещения нерелевантны, время можно «жёстко» установить (например, на старте — прыжок с 1.1.1970 на текущее время).
Процесс корректировки принимает на вход смещение (offset), дрейф (drift) и установку времени (time set), комбинирует их и применяет к таймеру. Смещение и дрейф равномерно распределяются во времени, обеспечивая плавные коррекции без скачков времени (например, 1 ppm реализуется как +1 нс каждые 5_000_000 тактов при 50 МГц). Параллельно вычисляется «качество» синхронизации для отметки состояния InSync, если несколько последовательных корректировок меньше порога.
Смещения и дрейф обычно являются выходами ПИ‑регуляторов (не являются частью Adjustable Clock). Параметры ПИ регуляторов, однако, предоставляются конфигурацией Adjustable Clock для передачи во внешние регуляторы. Входы смещения и дрейфа можно выбирать независимо (смещение часто нужно быстрее, чем дрейф).
Поскольку Adjustable Clock — «сердце» синхронизации, он принимает до 5 источников корректировок от разных ядер. В каждый момент активен только один источник. Выбор источника задаётся в наборе регистров (MUX). Источником может быть любой из 5 входов или CPU (режим REG), когда вычисления (ПИ и т. п.) выполняются на CPU, а их результаты подаются как time/offset/drift.
Набор регистров позволяет читать состояние InSync и InHoldover и делать снимок времени.

## 2. Описание интерфейса
### 2.1 Adjustable Clock IP
Интерфейс:
- Входы системного сброса и системной тактовой
- Интерфейс AXI4‑Lite для чтения/записи (в т. ч. регистров корректировок в REG‑режиме)
- Пять входов корректировок (time/offset/drift)
- Выход времени регулируемых часов (ClockTime) как опорного для других ядер
- Выходы коэффициентов ПИ регуляторов для смещения и дрейфа (полученных по AXI от CPU) — используются внешними ПИ‑регуляторами, если выбран источник, отличный от REG
- Выходные флаги статуса InSync и InHoldover

![Adjustable Clock IP](Additional%20Files/Adjustable%20Clock%20IP.png)

Параметры конфигурации:
- Период системной тактовой в наносекундах
- Порог InSync (нс). Минимум 4 последовательные корректировки смещения должны быть меньше порога, чтобы считать часы синхронизированными
- Таймаут InHoldover (сек). Если часы были InSync и корректировка смещения не поступала в течение таймаута — статус InHoldover

![Adjustable CLock Gui](Additional%20Files/Adjustable%20Clock%20configuration.png)

## 3. Набор регистров
Регистры доступны по AXI4‑Lite. Все регистры 32‑битные; не поддерживаются burst, невыравненные доступы, byte enable и таймауты. Адресное пространство не непрерывно; доступ вне диапазона — ошибка декодирования.

### 3.1 Обзор
![RegisterSet](Additional%20Files/Regset.png)

### 3.2 Описание регистров
![Control](Additional%20Files/Regset1_Control.png)
![Status](Additional%20Files/Regset2_Status.png)
![Select](Additional%20Files/Regset3_Select.png)
![Version](Additional%20Files/Regset4_Version.png)
![TimeL](Additional%20Files/Regset5_TimeL.png)
![TimeH](Additional%20Files/Regset6_TimeH.png)
![AdjL](Additional%20Files/Regset7_AdjL.png)
![AdjH](Additional%20Files/Regset8_AdjH.png)
![OffsetValue](Additional%20Files/Regset9_OffsetValue.png)
![OffsetIntrv](Additional%20Files/Regset10_OffsetIntrv.png)
![DriftVal](Additional%20Files/Regset11_DriftVal.png)
![DriftIntrv](Additional%20Files/Regset12_DriftIntrv.png)
![InSyncThresh](Additional%20Files/Regset13_InSyncThresh.png)
![Offset_ServoP](Additional%20Files/Regset15_OffsetServoP.png)
![Offset_ServoI](Additional%20Files/Regset14_OffsetServoI.png)
![Drift_ServoP](Additional%20Files/Regset16_DriftServoP.png)
![Drift_ServoI](Additional%20Files/Regset17_DriftServoI.png)
![ClkOffset](Additional%20Files/Regset18_ClkOffset.png)
![ClkDrift](Additional%20Files/Regset19_ClkDrift.png)

## 4. Описание дизайна
Adjustable Clock поддерживает до 5 внешних источников корректировок плюс регистровую корректировку (REG). Каждый источник может предоставить установку времени (TimeAdjustment), коррекцию смещения (OffsetAdjustment) или коррекцию частоты (DriftAdjustment). На выход подаются ClockTime и статусы InSync/InHoldover, а также коэффициенты ПИ, полученные по AXI.

### 4.1 Распределение смещения и дрейфа во времени
При установке времени таймер получает новое время напрямую.
При смещении/дрейфе входные значения транслируются в периодические малые корректировки, применяемые к таймеру. Примеры: дрейф 1 нс на 1000 нс преобразуется в +1 нс каждые 50 тактов при 50 МГц; смещение 50 нс за 2000 нс — +1 нс через такт при 50 МГц. Если смещение слишком велико (требуется более 1 нс за такт) — выполняется установка времени. Если дрейф слишком велик — ограничивается максимумом (1 нс за такт). В конце объединяются смещение и дрейф для применения к таймеру. Дрейф задаётся абсолютным значением, а не дельтой.

### 4.2 Применение коррекций
На каждом такте таймер либо применяет установку времени, либо увеличивается на период системной тактовой с учётом корректировок:
- активны «положительные» смещение и дрейф → +2 нс
- активны смещение и дрейф разного знака → 0 нс
- активны «отрицательные» смещение и дрейф → −2 нс
- активен только «положительный» смещение или дрейф → +1 нс
- активен только «отрицательный» смещение или дрейф → −1 нс
- иначе — период системной тактовой

### 4.3 Флаги качества
InSync:
- активируется, если минимум 4 последовательные корректировки смещения меньше порога
- сбрасывается при установке времени или отключении часов

InHoldover:
- активируется, если часы были InSync и корректировка смещения не поступала дольше таймаута
- сбрасывается при выходе из InSync, при установке времени/приходе корректировок или при отключении часов

### 4.4 AXI‑slave
AXI4‑Lite предоставляет доступ к регистрам для конфигурации корректировок и чтения статуса; мастер — CPU. Подробности — в [разделе 3](#3-register-set).
 
