# Описание дизайна Conf Master
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Описание дизайна](#3-design-description)

<a id="1-context-overview"></a>
## 1. Обзор
Conf Master — это ядро FPGA, которое предоставляет конфигурацию другим ядрам FPGA. Предполагается, что фиксированная конфигурация может быть подана в FPGA при запуске без участия CPU. Фиксированная конфигурация задаётся текстовым файлом, который загружается в ПЗУ (ROM) FPGA на этапе компиляции.

Процесс подачи конфигурации ядрам FPGA:
- Текстовый файл конфигурации создаётся вручную до компиляции FPGA‑дизайна. Он содержит команды доступа к AXI‑регистрам ядер FPGA в предопределённом формате.
- Файл загружается в битстрим FPGA на этапе компиляции. Файл конвертируется и подключается как содержимое ROM в составе битстрима.
- При старте (например, после снятия сброса) Conf Master считывает данные ROM и выполняет доступ к AXI‑регистрам соответствующих ядер FPGA.

<a id="2-interface-description"></a>
## 2. Описание интерфейса
### 2.1 Conf Master IP
Интерфейс Conf Master:
- Входы системного сброса и системной тактовой
- Интерфейс AXI4‑Lite master, через который Conf Master обращается к регистрам ядер FPGA
- «Sticky» флаговый выход, сигнализирующий о завершении конфигурации
 
![Conf Master IP](Additional%20Files/ConfMasterIP.png)

Параметры конфигурации ядра:
- Период системной тактовой в наносекундах
- Локальный путь к текстовому файлу конфигурации
- Таймаут AXI в тактах системной тактовой. Если к достижению таймаута доступ не завершён, конкретный доступ пропускается. Если таймаут равен «0», таймаут отключён, и доступ будет ожидать завершения бесконечно долго.

![Conf Master Gui](Additional%20Files/ConfMasterConfiguration.png)

### 2.2 Конфигурационный текстовый файл
Конфигурационный текстовый файл является универсальным входом для ядра Conf Master. Путь к файлу, имя и содержимое определяются до компиляции FPGA.
Формат файла предопределён:
- Каждая строка файла — это команда.
- Каждая строка должна содержать 4 поля, как показано в примере ниже.

|Тип команды|Базовый адрес|Адрес регистра|Данные|
|--------|--------|--------|--------|
|00000004|01010000|00000008|00000001|
|00000002|00000000|00000000|40000000|

- Шаблон файла доступен по ссылке [Configuration Template](Additional%20Files/ConfigurationTemplate.txt).
- Все 4 поля — восьмизначные HEX‑значения, разделённые символом пробела (без ведущего «0x», см. также [раздел 3.1](#31-text-file-parsing)).
- Пустые строки (начинающиеся с символов CR, LF, NUL, HT или пробела), а также строки‑комментарии (начинающиеся с «--» или «//») пропускаются.
- Недопустимые строки (например, слишком короткие или с неожиданным форматом) также пропускаются.

### 2.3 Структура команды
Поле «Тип команды» описано в таблице ниже.

|Тип команды|Код|Описание|
|--------|----------|---------------------------|
|Skip|0x00000001|Пропустить конкретную команду|
|Wait|0x00000002|Подождать указанное в «Данные» число наносекунд|
|Read|0x00000003|Прочитать указанный AXI‑регистр|
|Write|0x00000004|Записать указанный AXI‑регистр|

Поле «Базовый адрес» используется командами Read и Write. Это базовый адрес набора регистров ядра FPGA, к которым будет осуществлён доступ.

Поле «Адрес регистра» используется командами Read и Write. Это адрес 32‑битного регистра (смещение относительно базового адреса).

Поле «Данные» используется командами Write и Wait. Команда Write записывает значение «Данные» в указанный регистр. Команда Wait ожидает «Данные» наносекунд.

<a id="3-design-description"></a>
## 3. Описание дизайна
Ядро Conf Master состоит из двух основных частей:
- доступ к текстовому файлу и загрузка его в ROM (на этапе компиляции)
- AXI4‑Lite master для доступа к AXI‑регистрам в соответствии с содержимым ROM

### 3.1 Разбор текстового файла
Функция, которая получает доступ к текстовому файлу (его путь задаётся как конфигурация на этапе компиляции), ожидает строгий формат. Разбор выполняется построчно и завершается при достижении EOF.
Допустимый формат каждой строки:
- Строка начинается с CR, LF, HT, NUL или пробела — строка пропускается
- Строка начинается с символов комментария «--» или «//» — строка пропускается
- Строка принимается как команда, если:
  - символы 1–9 — восьмизначное HEX‑значение, затем пробел (« ») (Тип команды)
  - символы 10–18 — восьмизначное HEX‑значение, затем пробел (« ») (Базовый адрес)
  - символы 19–27 — восьмизначное HEX‑значение, затем пробел (« ») (Адрес регистра)
  - символы 28–35 — восьмизначное HEX‑значение (Данные)
  - дополнительные символы в строке игнорируются
  
Примеры:
- Выполнить запись по адресу 0x01000120 значением 0xDEADBEEF
  - 00000004 01000000 00000120 DEADBEEF
- Подождать 1 секунду (3B9ACA00 = 1000000000)
  - 00000002 00000000 00000000 3B9ACA00

### 3.2 AXI master
Conf Master должен иметь возможность читать и писать 32‑битные AXI‑регистры других ядер FPGA. Отклонение от спецификации AXI4‑Lite: если достигается таймаут, а доступ ещё не завершён (например, AXI‑slave не ответил), такой доступ пропускается вместо бесконечной блокировки шины.
