# Описание дизайна Core List
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Набор регистров](#3-register-set)

[4. Описание дизайна](#4-design-description)

<a id="1-context-overview"></a>
## 1. Обзор
Core List — это ядро FPGA, которое предоставляет CPU список ядер FPGA, инстанцированных в текущей версии дизайна. Предполагается, что CPU обращается к Core List при старте, чтобы проверить или корректно настроить диапазоны адресов для каждой инстанции ядра, маски прерываний и т. п.

Процесс предоставления списка ядер CPU:
- Текстовый файл Core List создаётся вручную до компиляции FPGA‑дизайна. Он содержит сведения о ядрах FPGA в предопределённом формате.
- Файл загружается в FPGA на этапе компиляции. FPGA сохраняет файл как содержимое ROM.
- CPU может прочитать информацию Core List, выполняя доступ к AXI‑регистрам ядра Core List.

<a id="2-interface-description"></a>
## 2. Описание интерфейса
### 2.1 Core List IP
Интерфейс Core List:
- Входы системного сброса и системной тактовой
- Интерфейс AXI4‑Lite slave, через который CPU читает информацию Core List (база всегда должна быть по фиксированному адресу, чтобы ПО знало куда обращаться)
- «Sticky» флаговый выход, сигнализирующий, что список был прочитан CPU
 
![Core List IP](Additional%20Files/CoreList%20IP.png)

Параметры конфигурации ядра:
- Период системной тактовой в наносекундах
- Локальный путь к текстовому файлу Core List

![Core List Gui](Additional%20Files/Core%20List%20Customization%20options.png)

### 2.2 Текстовый файл Core List
Текстовый файл Core List является конфигурационным входом ядра. Путь, имя и содержимое файла определяются до компиляции FPGA.
Формат файла предопределён:
- Каждая строка описывает одну инстанцию ядра в дизайне
- Каждая строка должна иметь 8 полей, как в примере ниже

|Номер типа ядра|Номер инстанции|Номер версии|Нижний адрес диапазона|Верхний адрес диапазона|Номер прерывания|Чувствительность прерывания|Magic word (до 36 ASCII символов, опционально)|
|--------|--------|--------|--------|--------|--------|--------|------------------------------------|
|00000001|00000002|00000003|10000000|1000FFFF|0000001A|00000001|Core Type Example 1|

- Шаблон файла доступен по ссылке [Core List Template](Additional%20Files/CoreListTemplate.txt).
- Первые 7 полей — это восьмизначные HEX‑значения, разделённые символом пробела (без ведущего «0x», см. также [раздел 4.1](#41-text-file-parsing)).
- Последнее поле («Magic Word») — необязательное короткое описание инстанции в ASCII, до 36 символов.
- Пустые строки (начинающиеся с CR, LF, NUL, HT или пробела) и строки‑комментарии (начинающиеся с «--» или «//») пропускаются.

Ядро Core List добавляет недопустимый номер типа ядра «00000000» как признак для CPU, что чтение всего списка завершено.

### 2.3 Содержимое Core List
Некоторые типы ядер предопределены:

|Ядро|Номер типа ядра (hex)|
|--------------------------|:------:|
|Invalid/End                         |0x00000000|
|TC Core List Core Type              |0x00000001|
|TC Adjustable Clock Core Type       |0x00000002|
|TC Signal Generator Core Type       |0x00000003|
|TC Signal Timestamper Core Type     |0x00000004|
|TC PPS Generator Core Type          |0x00000005|
|TC Frequency Counter                |0x00000006|
|TC Clock Detector Core Type         |0x00000007|
|TC SMA Selector Core Type           |0x00000008|
|TC PPS Source Selector Core Type    |0x00000009|
|TC FPGA Version Core Type           |0x0000000A|
|TC PPS Slave Core Type              |0x0000000B|
|TC ToD Slave Core Type              |0x0000000C|
|TC Dummy Axi Slave Core Type        |0x0000000D|
|Xilinx AXI PCIe Core Type           |0x00010000|
|Xilinx AXI GPIO Core Type           |0x00010001|
|Xilinx AXI IIC Core Type            |0x00010002|
|Xilinx AXI UART Core Type           |0x00010003|
|Xilinx AXI HWICAP Core Type         |0x00010004|
|Xilinx AXI QUAD SPI FLASH Core Type |0x00010005|

Номер инстанции ядра указывает порядковый номер инстанцирования данного типа, начиная с «0».

Номер версии обычно имеет формат 0xMMmmBBBB, где MM — Major‑версия (8 бит), mm — Minor‑версия (8 бит), BBBB — Build‑версия (16 бит). Если у ядра версия хранится только в 2 байтах, Build считается «0».

AddressRangeLow — смещение базового адреса AXI‑slave ядра; AddressRangeHigh — максимальный адрес AXI‑slave ядра.

Текущий дизайн может предоставлять до 32 прерываний. Номер прерывания имеет диапазон 0x0–0x1F; значение 0xFFFFFFFF используется, если ядро не генерирует прерываний.

Чувствительность прерывания содержит информацию о типе прерывания ядра:
- Если bit0 = 0 — прерывание по фронту; иначе — уровневое
- Если bit1 = 0 — активный низкий уровень; иначе — активный высокий

Magic Word — короткое представление инстанции в ASCII (максимум 36 символов).

<a id="3-register-set"></a>
## 3. Набор регистров
CPU получает Core List, выполняя чтение памяти‑отображаемых регистров ядра Core List по AXI. Каждая инстанция ядра занимает предопределённый диапазон из 16 слов по 32 бита (64 байта на инстанцию в ROM). Инстанции хранятся в ROM в порядке, указанном в текстовом файле. Для удобства инстанция Core List должна быть первой в файле, а адресное пространство Core List должно быть фиксировано в диапазоне [0x01300000–0x0130FFFF].

**CPU должен начинать чтение с базового адреса Core List (0x01300000) и завершать чтение при обнаружении недопустимого номера типа ядра (0x00000000).**

### 3.1 Обзор набора регистров
Номер типа ядра каждой инстанции всегда хранится по адресам **[0x01300000 + N*(0x40)]**, где **N** — номер инстанции, как в текстовом файле. Обзор набора регистров показан ниже (приведены адреса для первых двух инстанций и N‑й инстанции):
![RegisterSet](Additional%20Files/CoreListRegsetOverview.png)

### 3.2 Описание регистров
Ниже приведены регистры первой инстанции списка. Регистры остальных инстанций идентичны, за исключением смещений адресов, приведённых выше.
![CoreTypeNr](Additional%20Files/Regset1.TypeNr.png)
![CoreInstanceNr](Additional%20Files/Regset2.InstanceNr.png)
![VersionNr](Additional%20Files/Regset3.VersionNr.png)
![AddressLow](Additional%20Files/Regset4.AddressLow.png)
![AddressHigh](Additional%20Files/Regset5.AddressHigh.png)
![Interrupt](Additional%20Files/Regset6.Interrupt.png)
![Sensitivity](Additional%20Files/Regset7.Sensitivity.png)
![Word1](Additional%20Files/Regset8_Word1.png)
![Word2](Additional%20Files/Regset8_Word2.png)
![Word3](Additional%20Files/Regset8_Word3.png)
![Word4](Additional%20Files/Regset8_Word4.png)
![Word5](Additional%20Files/Regset8_Word5.png)
![Word6](Additional%20Files/Regset8_Word6.png)
![Word7](Additional%20Files/Regset8_Word7.png)
![Word8](Additional%20Files/Regset8_Word8.png)
![Word9](Additional%20Files/Regset8_Word9.png)

<a id="4-design-description"></a>
## 4. Описание дизайна
Ядро Core List состоит из двух основных частей:
- доступ к текстовому файлу и загрузка его содержимого в ROM (на этапе компиляции)
- AXI4‑Lite slave, предоставляющий содержимое ROM CPU

### 4.1 Разбор текстового файла
Функция, читающая текстовый файл (путь задаётся как конфигурация на этапе компиляции), ожидает строгий формат; в противном случае сообщается «ошибка». Разбор выполняется построчно и завершается при достижении конца файла.
Допустимый формат строки:
- строка начинается с CR, LF, HT, NUL или пробела — строка пропускается
- строка начинается с «--» или «//» — строка пропускается
- строка с описанием ядра должна содержать:
  - символы 1–9: восьмизначное HEX‑значение + пробел (« ») (Core Type Nr)
  - символы 10–18: восьмизначное HEX‑значение + пробел (« ») (Core Instance Nr)
  - символы 19–27: восьмизначное HEX‑значение + пробел (« ») (Core Version Nr)
  - символы 28–36: восьмизначное HEX‑значение + пробел (« ») (Address Range Low)
  - символы 37–45: восьмизначное HEX‑значение + пробел (« ») (Address Range High)
  - символы 46–54: восьмизначное HEX‑значение + пробел (« ») (Interrupt Nr)
  - символы 55–62: восьмизначное HEX‑значение (Interrupt Sensitivity)
  - символ 63: специальный символ NUL/LF/CR/HT (конец строки) либо пробел (« »), после которого может идти опциональное поле Magic Word
  - символы 64–99: опциональный текст до 36 символов ASCII; парсится посимвольно до конца строки или до 36 символов. Избыточный текст игнорируется (усекается) (Magic Word)

### 4.2 AXI‑slave
CPU читает содержимое ROM последовательно, начиная с базового адреса, и прекращает чтение, когда встречает недопустимый номер типа ядра («0x00000000»). Доступы чтения CPU — 32‑битные, по выровненным адресам (кратным 4). Иначе FPGA автоматически вернёт содержимое ближайшего выровненного адреса. Например, чтение по адресу 0x01300004 вернёт данные адресов [0x01300004–0x01300007]. Чтение по 0x01300005/06/07 вернёт тот же результат. Это соответствует спецификации AXI4‑Lite.



 
