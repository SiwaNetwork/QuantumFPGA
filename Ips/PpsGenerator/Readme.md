# Описание дизайна PPS Generator
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Набор регистров](#3-register-set)

[4. Описание дизайна](#4-design-description)

<a id="1-context-overview"></a>
## 1. Обзор
PPS Generator — полностью аппаратная (FPGA) реализация, генерирующая импульс PPS (Pulse Per Second), выровненный по новой секунде локальных часов. Ядро настраивается через интерфейс регистров AXI4‑Lite.

<a id="2-interface-description"></a>
## 2. Описание интерфейса
### 2.1 PPS Generator IP
Интерфейс PPS Generator:
- Входы системного сброса и системной тактовой
- Вход высокоточной тактовой для высокой точности меток (целое кратное системной тактовой, фиксированная связь, например от общего PLL)
- Вход локального времени от [Adjustable Clock](../AdjustableClock/Readme.md)
- Интерфейс AXI4‑Lite slave, через который CPU читает и пишет регистры генератора PPS
- Выходной сигнал PPS
 
![PPS Generator IP](Additional%20Files/PpsGenIp.png)

Параметры конфигурации ядра:
- Период системной тактовой в наносекундах
- Множитель частоты высокоточной тактовой, показывающий во сколько раз она быстрее системной
- Опция включения/отключения компенсации задержки кабеля. Если включена, генератор компенсирует задержку кабеля, задаваемую по AXI в наносекундах
- Компенсируемая выходная задержка в наносекундах (только положительное значение)
- Полярность генерируемого сигнала. Если «1», сигнал активный высокий; иначе — активный низкий

![Pps Generator Gui](Additional%20Files/PpsGenGui.png)

<a id="3-register-set"></a>
## 3. Набор регистров
Набор регистров генератора PPS доступен через AXI4‑Lite (memory‑mapped). Все регистры 32‑битные; не поддерживаются burst‑доступы, невыравненные доступы, byte enable и таймауты. Адресное пространство регистров не является непрерывным. Адреса регистров — это только смещения в диапазоне памяти, куда ядро отображено в AXI interconnect. Доступ к несуществующим адресам в отображённой области отвечает ошибкой декодирования slave.

### 3.1 Обзор набора
Обзор набора регистров показан ниже.
![RegisterSet](Additional%20Files/RegsetOverview.png)

### 3.2 Описание регистров
Ниже приведены регистры PPS Generator.
![Control](Additional%20Files/Regset1_Control.png)
![Status](Additional%20Files/Regset2_Status.png)
![Polarity](Additional%20Files/Regset3_Polarity.png)
![Version](Additional%20Files/Regset4_Version.png)
![Width](Additional%20Files/Regset5_Width.png)
![Cable](Additional%20Files/Regset6_Cable.png)

<a id="4-design-description"></a>
## 4. Описание дизайна
Генератор PPS принимает (синхронизированное) локальное время в качестве опоры и формирует импульс PPS, выровненный по этому времени (время старта и период), компенсируя выходную задержку. Ядро содержит AXI4‑Lite‑slave для конфигурации и мониторинга со стороны CPU. Компонент состоит из трёх основных операций:
- Периодическая генерация импульса, выровненного по локальному времени
- Точная подстройка момента активации импульса высокоточной тактовой
- Интерфейс с CPU (AXI‑master) через AXI‑slave

<a id="4-1-periodically-generate-the-pps"></a>
### 4.1 Периодическая генерация PPS
При включении генерации и заданной конфигурации генерация начинается в начале новой секунды локального времени. Для этого сравнивается текущее локальное время с максимальным значением наносекунд (1000000000) за вычетом накопленных выходных задержек. Для высокоточной генерации фиксируется, сколько периодов высокоточной тактовой «умещается» между этими значениями; результат сохраняется в сдвиговом регистре.
Скважность импульса фиксирована — 500 мс. Обратите внимание: скважность измеряется свободно бегущим счётчиком, поэтому деактивация импульса не выравнивается по локальному времени.
Если локальное время отключено или произошёл скачок времени, генератор PPS сообщает об ошибке. Генерация будет продолжена, когда ошибка устранена и импульс деактивирован.

### 4.2 Вычисление точного времени генерации
Для вычисления точного времени генерации, помимо компенсации выходных задержек, импульс может генерироваться высокоточной тактовой, частота которой кратна частоте системной тактовой. Сдвиговый регистр, отмеченный в домене системной тактовой (см. [раздел 4.1](#4-1-periodically-generate-the-pps)), переносится в домен высокоточной тактовой. Число периодов высокоточной тактовой, которые «умещаются» в этой разнице, определяет момент генерации PPS в высокоточном домене.

### 4.3 AXI‑slave генератора PPS
PPS Generator включает AXI4‑Lite memory‑mapped slave. Он предоставляет доступ ко всем регистрам и позволяет конфигурировать генератор. AXI‑master (обычно CPU) должен записать наборы регистров через AXI‑записи. Также предоставляется интерфейс статуса для мониторинга. В [разделе 3](#3-register-set) приведено полное описание набора регистров.
