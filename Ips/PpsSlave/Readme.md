# Описание дизайна PPS Slave
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Набор регистров](#3-register-set)

[4. Описание дизайна](#4-design-description)

## 1. Обзор
PPS Slave — полностью аппаратная (FPGA) реализация, рассчитывающая коррекции смещения и дрейфа локальных часов для синхронизации с входом PPS. При поступлении PPS снимается метка времени и валидируется импульс. Если ширина и период импульса валидны, по отношению к входному PPS вычисляются смещение и дрейф локальных часов. Для сглаживания применяются ПИ‑регуляторы. Конфигурация и мониторинг — через AXI4‑Lite.

## 2. Описание интерфейса
### 2.1 PPS Slave IP
Интерфейс:
- Входы системного сброса и системной тактовой
- Вход высокоточной тактовой (целое кратное системной)
- Вход локального времени от [Adjustable Clock](../AdjustableClock/Readme.md)
- Вход события PPS
- Входные коэффициенты ПИ (для опционального обновления значений по умолчанию)
- Выходы рассчитанных коррекций смещения и дрейфа в [Adjustable Clock](../AdjustableClock/Readme.md)
- Интерфейс AXI4‑Lite для доступа к регистрам

![PPS Slave IP](Additional%20Files/PpsSlave_IP.png)

Параметры конфигурации:
- Период системной тактовой в нс
- Множитель частоты высокоточной тактовой
- Включение/отключение компенсации задержки кабеля (значение по AXI в нс)
- Компенсируемая входная задержка в нс (положительная)
- Полярность PPS (фронт нарастания — '1', иначе спада)
- Значения коэффициентов ПИ для смещения/дрейфа:
  - K_I_Offset = (OffsetMultiplyFactorI/OffsetDivideFactorI)*2^16
  - K_P_Offset = (OffsetMultiplyFactorP/OffsetDivideFactorP)*2^16
  - K_I_Drift  = (DriftMultiplyFactorI/DriftDivideFactorI)*2^16
  - K_P_Drift  = (DriftMultiplyFactorP/DriftDivideFactorP)*2^16

![PPS Slave Gui](Additional%20Files/PpsSlave_Config.png)

## 3. Набор регистров
AXI4‑Lite; все регистры 32‑битные; без burst/byte enable/таймаутов/невыравненных доступов; вне диапазона — ошибка декодирования.

### 3.1 Обзор
![RegisterSet](Additional%20Files/PpsSlave_Regset.png)

### 3.2 Описание регистров
![Control](Additional%20Files/Reg1_Control.png)
![Status](Additional%20Files/Reg2_Status.png)
![Polarity](Additional%20Files/Reg3_Polarity.png)
![Version](Additional%20Files/Reg4_Version.png)
![PulseWidth](Additional%20Files/Reg5_PulseWidth.png)
![CableDelay](Additional%20Files/Reg6_CableDelay.png)

## 4. Описание дизайна
PPS Slave использует вход PPS как опорный относительно локального времени и рассчитывает коррекции смещения и дрейфа.

### 4.1 Метка PPS на высокоточной тактовой
Частота высокоточной тактовой — целое кратное системной. При обнаружении настроенного фронта PPS событие «отмечается» в сдвиговом регистре высокочастотного домена, переносится в домен системной частоты и вычисляется высокоточная задержка (сдвиг доменов и фазовая разница тактов). Дополнительно компенсируются входная и кабельная задержки (при включении).

### 4.2 Валидация входа PPS
Проверяются период и длительность импульса. При поступлении PPS запускается таймер периода до следующего PPS (или до макс. значения). Ожидаемое значение — около 1 сек с допуском ±100 мс. Если вне окна — метка игнорируется и в регистре статуса устанавливается «sticky» ошибка периода.
Таймер ширины импульса измеряет длительность активного уровня; ожидаемая ширина: от 1 мс до 999 мс. Нарушение — «sticky» ошибка ширины. Чтобы избежать ложных срабатываний при включении, после enable вход PPS игнорируется до двух активных фронтов.

### 4.3 Расчёт корректировок
Сначала вычисляются смещение и дрейф по меткам PPS. Смещение — разность метки и ближайшей смены секунды (положительное — после новой секунды, отрицательное — до). Дрейф — (1 сек − разность двух последовательных меток − предыдущее смещение), нормированная по интервалу между метками. Затем значения подаются на ПИ‑регуляторы (см. график), формируя плавные корректировки. Выходы регуляторов подаются в [Adjustable Clock](../AdjustableClock/Readme.md).

![PiServo](Additional%20Files/PiServo.png)

### 4.4 AXI‑slave
AXI4‑Lite предоставляет доступ к регистрам для конфигурации и мониторинга, типично со стороны CPU. Подробности — в [разделе 3](#3-register-set).
   
