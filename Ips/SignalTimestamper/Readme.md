# Описание дизайна Signal Timestamper
## Содержание

[1. Обзор](#1-context-overview)

[2. Описание интерфейса](#2-interface-description)

[3. Набор регистров](#3-register-set)

[4. Описание дизайна](#4-design-description)

## 1. Обзор
Signal Timestamper — полностью аппаратная (FPGA) реализация. Позволяет снимать метки времени события на настраиваемом фронте сигнала. Метки снимаются на выбранном фронте; генерируются прерывания. Предназначен для подключения к CPU или другому AXI‑master, считывающему метки. Настройки выполняются через интерфейс регистров AXI4‑Lite.

## 2. Описание интерфейса
### 2.1 Signal Timestamper IP
Интерфейс:
- Входы системного сброса и системной тактовой частоты
- Вход высокочастотного тактового сигнала для высокой точности (целое кратное системной частоте, фиксированная связь, например общий PLL)
- Вход локального времени от [Adjustable Clock](../AdjustableClock/Readme.md)
- Вход события, для которого снимается метка
- Интерфейс AXI4‑Lite для доступа к регистрам
- Необязательный выход прерывания при снятии метки

![Signal Timestamper IP](Additional%20Files/SigTimestamper%20IP.png)

Параметры конфигурации:
- Период системной тактовой в наносекундах
- Множитель частоты высокоточного тактирования
- Включение/отключение компенсации задержки кабеля (значение задаётся по AXI в нс)
- Компенсируемая входная задержка в нс (например, задержка буферов, всегда положительная)
- Полярность входа события: '1' — метка на фронте нарастания; иначе — на спаде

![Signal Timestamper Gui](Additional%20Files/SigTimestamper%20Configuration.png)

## 3. Набор регистров
Набор регистров доступен по AXI4‑Lite. Все регистры 32‑битные; не поддерживаются burst, невыравненные доступы, byte enable и таймауты. Адресное пространство не непрерывно; доступ вне диапазона — ошибка декодирования.

### 3.1 Обзор
![RegisterSet](Additional%20Files/RegsetOverview.png)

### 3.2 Описание регистров
![Control](Additional%20Files/Regset1_Control.png)
![Status](Additional%20Files/Regset2_Status.png)
![Polarity](Additional%20Files/Regset3_Polarity.png)
![Version](Additional%20Files/Regset4_Version.png)
![Cable](Additional%20Files/Regset5_Cable.png)
![IRQ](Additional%20Files/Regset6_Irq.png)
![MSK](Additional%20Files/Regset7_Msk.png)
![EventCount](Additional%20Files/Regset8_EvtCnt.png)
![TsCount](Additional%20Files/Regset9_TsCnt.png)
![TsLow](Additional%20Files/Regset10_TsL.png)
![TsHigh](Additional%20Files/Regset11_TsH.png)
![TsDataWdth](Additional%20Files/Regset12_DataWdth.png)
![TsData](Additional%20Files/Regset13_Data.png)

## 4. Описание дизайна
Timestamper принимает (синхронизированное) время и вход события и формирует метки времени по выбранной полярности, компенсируя входную задержку. Событие также вызывает прерывание для CPU. При каждом фронте увеличивается внутренний счётчик событий (позволяет выявлять пропуски, так как timestamper блокируется до очистки IRQ CPU). Ядро содержит AXI4‑Lite для конфигурации/статуса и чтения меток CPU.
Состоит из 3 операций:
- Снятие метки времени с использованием высокоточной тактовой
- Вычисление точного времени метки
- Интерфейс с CPU через AXI‑slave

### 4.1 Метка на высокоточной тактовой
Частота высокоточной тактовой — целое кратное системной. Для снижения джиттера метки событие «отмечается» в сдвиговом регистре на высокочастотном домене, затем переносится в домен системной частоты; это позволяет вычислить высокоточное «окно» и компенсировать его.

### 4.2 Вычисление точного времени метки
Компенсируются задержки:
- Высокоточная задержка (переключение доменов и фаза тактов)
- Входная задержка (конфигурация, только положительная)
- Задержка кабеля (конфигурация по AXI при включённой опции, только положительная)

### 4.3 AXI‑slave
AXI4‑Lite предоставляет доступ к конфигурации, статусу и данным меток; типичный мастер — CPU. Подробности — в [разделе 3](#3-register-set).
   
